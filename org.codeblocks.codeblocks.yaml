app-id: org.codeblocks.codeblocks
runtime: org.freedesktop.Sdk
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
rename-desktop-file: codeblocks.desktop
rename-icon: codeblocks
command: codeblocks
finish-args:
  - --allow=devel
  - --device=dri
  - '--env=TERMINFO_DIRS=/app/share/terminfo:'
  - --filesystem=home
  - --filesystem=host
  - --share=ipc
  - --share=network
  - --socket=session-bus
  - --socket=ssh-auth
  - --socket=system-bus
  - --socket=wayland
  - --socket=x11
cleanup:
  - /share/metainfo/codeblocks.appdata.xml
  - '*.a'
  - '*.la'
modules:
  - name: codeblocks
    build-options:
      cxxflags: -std=gnu++14
    config-opts:
      - --with-boost-libdir=/app/lib
      - --with-contrib-plugins=all,-FileManager,-dragscroll
    post-install:
      - mv ${FLATPAK_DEST}/bin/codeblocks{,-bin}
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo/
      - mv ${FLATPAK_DEST}/share/mime/packages/{,org.codeblocks.}codeblocks.xml
      - mv ${FLATPAK_DEST}/share/icons/hicolor/48x48/mimetypes/{,${FLATPAK_ID}-}application-x-codeblocks.png
      - mv ${FLATPAK_DEST}/share/icons/hicolor/48x48/mimetypes/{,${FLATPAK_ID}-}application-x-codeblocks-workspace.png
      - install -Dm644 codeblocks-64.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/codeblocks.png
      - install -Dm644 codeblocks-128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/codeblocks.png
    sources:
      - type: svn
        url: svn://svn.code.sf.net/p/codeblocks/code/trunk
        revision: '12847'
      - type: file
        path: org.codeblocks.codeblocks.metainfo.xml
      - type: patch
        path: codeblocks-icon-name-for-mimetype.patch
      - type: patch
        path: codeblocks-default-terminal.patch
      - type: patch
        path: codeblocks-open-txt-files-in-builtin-editor.patch
      - type: shell
        commands:
          - ./bootstrap
          - sed -i 's|$(datadir)/pixmaps|$(datadir)/icons/hicolor/64x64/apps|' src/mime/Makefile.{am,in}
          - sed -i 's|$(datarootdir)/appdata|$(datarootdir)/metainfo|' Makefile.{am,in}
            src/plugins/contrib/appdata/Makefile.{am,in}
      - type: file
        path: codeblocks-64.png
      - type: file
        path: codeblocks-128.png
    modules:
      - name: boost
        # boost system lib required for NassiShneiderman contrib plugin
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh
          - ./b2 --with-system variant=release link=shared debug-symbols=off runtime-link=shared
            --prefix=${FLATPAK_DEST} install
        sources:
          - type: archive
            url: https://boostorg.jfrog.io/artifactory/main/release/1.79.0/source/boost_1_79_0.tar.bz2
            sha256: 475d589d51a7f8b3ba2ba4eda022b170e562ca3b760ee922c146b6c65856ef39
            x-checker-data:
              type: anitya
              project-id: 6845
              stable-only: true
              url-template: https://boostorg.jfrog.io/artifactory/main/release/$major.$minor.$patch/source/boost_${major}_${minor}_$patch.tar.bz2
        cleanup:
          - /include
          - /lib/cmake
      - name: wxwidgets
        sources:
          - type: archive
            url: https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.0/wxWidgets-3.2.0.tar.bz2
            sha256: 356e9b55f1ae3d58ae1fed61478e9b754d46b820913e3bfbc971c50377c1903a
            x-checker-data:
              type: html
              url: https://www.wxwidgets.org/downloads
              version-pattern: 'Latest Stable Release: ([\d\.-]+)'
              url-template: https://github.com/wxWidgets/wxWidgets/releases/download/v$version/wxWidgets-$version.tar.bz2
        cleanup:
          - /bin
          - /include
          - /lib/wx
          - /share/aclocal
          - /share/bakefile

  - name: termite
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/aperezdc/termite/releases/download/v16.4/termite-16.4.tar.xz
        sha256: e9a2105ca9310b616647cb63a0d0c8be7dbf003fd0ca68c5e4c64ed57a0b20ad
        x-checker-data:
          type: anitya
          project-id: 11226
          stable-only: true
          url-template: https://github.com/aperezdc/termite/releases/download/v$version/termite-$version.tar.xz
    cleanup:
      - /include
      - /lib/pkgconfig
      - /lib/systemd
      - /share/applications
      - /share/man
      - '*.a'

  - name: ide-flatpak-wrapper
    buildsystem: meson
    config-opts:
      - -Deditor_binary=/app/bin/codeblocks-bin
      - -Deditor_title=Code::Blocks IDE
      - -Dprogram_name=codeblocks
      - -Dsdk_version=21.08
    sources:
      - type: git
        url: https://github.com/flathub/ide-flatpak-wrapper.git
        commit: a488c7f170d06ca317daeac3c39720d0760f5ded
        x-checker-data:
          type: json
          url: https://api.github.com/repos/flathub/ide-flatpak-wrapper/commits?sha=master&per_page=1
          commit-query: .[].sha
          version-query: .[].sha[0:8]
          timestamp-query: .[].commit.committer.date
      - type: patch
        path: ide-flatpak-wrapper-first_run.patch
